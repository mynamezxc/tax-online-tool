/*
    Maintainer: Mynamezxc
    Email: nguyennh.ts24@gmail.com
    Version: v1.1
    Date: 09-10-2020
    Copyright TS24 2020
    Website: https://web.ts24.com.vn/
*/
const eSginer_path=__dirname+"/eSigner",key="e8e3fa20d2588dfb1d1281caaf94332c",puppeteer=require("puppeteer"),http=require("http"),express=require("express"),bodyParser=require("body-parser"),parseJson=require("parse-json"),fs=require("fs"),app=express(),port=3e3,path=require("path"),base64=require("base-64"),utf8=require("utf8");app.use(express.static("public")),app.use(bodyParser.json({limit:"50mb",extended:!0})),app.use(bodyParser.urlencoded({limit:"50mb",extended:!0})),app.use(bodyParser.text({limit:"50mb",type:"text/plain"})),app.set("view engine","ejs");const browser_options=["--no-sandbox","--disable-setuid-sandbox","--load-extension="+eSginer_path,"--disable-extensions-except="+eSginer_path,"--disable-infobars","--window-size=100,130","--disable-infobars","--window-position=99999,0"];var browsers=[];function delay(e){return new Promise(a=>setTimeout(a,e))}function makeid(e){for(var a="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",s=t.length,r=0;r<e;r++)a+=t.charAt(Math.floor(Math.random()*s));return a}async function getSession(e){let a=await e.url(),t=a.indexOf("=")+1,s=a.indexOf("&dse_applicationId")-1;return a.substring(t,s+1)}async function createBrowser(e){const a=await puppeteer.launch({args:browser_options,headless:!1,Devtools:!1});try{let s=await a.pages();var t=s[0];2==s.length&&(t=s[1]);let r="https://thuedientu.gdt.gov.vn";return await t.setViewport({width:1366,height:768}),await t.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:81.0) Gecko/20100101 Firefox/81.0"),await t.goto(r,{timeout:3e4,waitUntil:"networkidle0"}),r="https://thuedientu.gdt.gov.vn/etaxnnt/Request?&dse_sessionId="+await getSession(t)+"&dse_applicationId=-1&dse_pageId=7&dse_operationName=corpIndexProc&dse_errorPage=error_page.jsp&dse_processorState=initial&dse_nextEventName=login",await t.goto(r,{timeout:3e4,waitUntil:"networkidle0"}),await t.screenshot({path:"public/captcha/"+e+".png",clip:{x:944,y:198,width:74,height:35}}),a}catch(e){return console.log(e),await a.close(),!1}}async function fillCaptchaAndLogin(e,a,t,s){let r=await browsers[e].pages();var o=r[0];2==r.length&&(o=r[1]),await o.evaluate((e,a,t)=>{document.querySelector("#_userName").value=e,document.querySelector("#password").value=a,document.querySelector("#vcode").value=t,document.querySelector("#dangnhap").click()},t,s,a),await delay(3e3);let i=await o.content();return-1!=i.search("btn_logout.gif")||-1!=i.search("Hệ thống đang thực hiện kiểm tra bản cập nhật. Vui lòng chờ trong giây lát")||(await o.screenshot({path:"public/captcha/"+e+".png",clip:{x:944,y:198,width:74,height:35}}),!1)}async function closeBrowser(e){await e.close()}async function eSigner(e,a){let t=await browsers[e].pages(),s=t[0];2==t.length&&(s=t[1]);try{var r=await s.$(".text_den"),o=await s.evaluate(e=>e.textContent,r);if(""!=o){if(5!=path.basename(a).split("-").length)return!1;var i=path.basename(a).split("-");if(10==i[1].length)var n=i[1]+"000";else n=i[1];if(10==o.length&&(o+="000"),n!=o)return!1}}catch(e){return!1}let l="https://thuedientu.gdt.gov.vn/etaxnnt/Request?&dse_sessionId="+await getSession(s)+"&dse_applicationId=-1&dse_pageId=9&dse_operationName=uploadTaxOnlineProc&dse_processorState=initial&dse_nextEventName=start",d=await browsers[e].newPage();await d.setViewport({width:1366,height:768}),await d.goto(l);var c=path.basename(a),u=__dirname.replace("\\","/")+"/upload/"+c;try{var p=0,g=path.extname(c);if(".xls"==g)p=5;else if(".xlsx"==g)p=6;else if(".doc"==g)p=7;else if(".docx"==g)p=8;else if(".xml"==g)p=9;else{if(".pdf"!=g)return!1;p=1}if(9!=p)return!1;await d.evaluate((e,a,t)=>{document.querySelector("#fullPathFileName").value=a,document.querySelector("#tkhaiFormat").value=e,document.querySelector("#fileName").value=t,document.querySelector("#uploadButton").click()},p,u,c),await delay(5e3),await d.content();try{fs.unlink("./upload/"+c,e=>{e?console.log("failed to delete local file:"+e):console.log("successfully deleted local file")});const e=await d.evaluate(()=>{return Array.from(document.querySelectorAll(".tbl_member table tr td")).map(e=>e.innerText)});if(e[1])return console.log("Transaction no "+e[1].trim()),await d.close(),e[1]}catch(e){return await d.close(),!1}}catch(e){await d.close()}return!1}app.get("/:browser_id",async(e,a)=>{var t=e.params.browser_id;if(e.query.key==key){if(browsers[t])try{await closeBrowser(browsers[t]),delete browsers[t],console.log("Reopen browser "+t)}catch(e){console.log("Browser close with error")}browsers[t]="1";var s=await createBrowser(t);console.log("Browser generated with id "+t),s?(browsers[t]=s,a.send({id:t,status:!0,message:"Waiting for captcha",image:"captcha/"+t+".png"})):(delete browsers[t],a.send({id:t,status:!1,message:"Connection error"}))}else a.send({status:!1,message:"Key error"})}),app.get("/login/:browser_id/:captcha/:username/:password",async(e,a)=>{if(e.query.key==key){var t=e.params.browser_id,s=e.params.captcha,r=e.params.username,o=e.params.password;if(browsers[t]&&""!=s&&""!=r&&""!=o)await fillCaptchaAndLogin(t,s,r,o)?(fs.unlink("./public/captcha/"+t+".png",e=>{e?console.log("failed to delete local image:"+e):console.log("successfully deleted local image")}),a.send({id:t,status:!0,message:"Login success"})):a.send({id:t,status:!1,message:"Captcha, username or password was wrong. Please try again",image:"captcha/"+t+".png"});else a.send({id:t,status:!1,message:"Missing parameters or browser busy",image:"captcha/"+t+".png"})}else a.send({status:!1,message:"Key error"})}),app.post("/upload-file/:browser_id",async(e,a)=>{if(e.query.key==key){var t=e.params.browser_id;console.log(e.body);var s=parseJson(e.body);if(s.file&&s.file_name){var r="./upload/"+s.file_name;fs.writeFileSync(r,utf8.decode(base64.decode(s.file)));var o="";if(browsers[t]){var i=await eSigner(t,r);return i?void a.send({id:t,status:!0,message:"Upload success",transaction_id:i}):void a.send({id:t,status:!1,message:"Content or filename is not support with this account, ext .xml and syntax required"})}""!=(o="Browser ID does not exists or died")?a.send({id:t,status:!1,message:o}):a.send({id:t,status:!0,message:"Upload success"})}else a.send({id:t,status:!1,message:"Missing parameter file or file_content"})}else a.send({status:!1,message:"Key error"})}),app.post("/upload-attachment/:browser_id",async(e,a)=>{var t=e.params.browser_id,s={status:!1,browser_id:t,message:"Message sent to desktop"};if(e.query.key==key){var r=parseJson(e.body);if(t&&browsers[t]&&r.file&&r.file_name&&r.transaction_id&&r.attachment_code){var o=r.transaction_id,i=r.attachment_code;if(!r.file||!r.file_name)return void a.send({id:t,status:!1,message:"Missing parameter file or file_content"});var n="./upload/"+r.file_name;fs.writeFileSync(n,base64.decode(r.file),"binary");var l=await browsers[t].pages(),d=l[0];2==l.length&&(d=l[1]);var c="https://thuedientu.gdt.gov.vn/etaxnnt/Request?dse_sessionId="+await getSession(d)+"&dse_applicationId=-1&dse_operationName=traCuuToKhaiProc&dse_pageId=18&dse_processorState=viewTraCuuTkhai&dse_nextEventName=gui_phu_luc&tkhaiID="+o;let e=await browsers[t].newPage();await e.setViewport({width:1366,height:768}),await e.goto(c);var u=path.basename(n),p=__dirname.replace("\\","/")+"/upload/"+u,g=path.extname(u);if(".xls"==g)format=5;else if(".xlsx"==g)format=6;else if(".doc"==g)format=7;else if(".docx"==g)format=8;else{if(".pdf"!=g)return s.status=!1,s.message="This file is not support, XML PDF WORD EXCEL required",void a.send(s);format=1}await e.evaluate((e,a,t,s)=>{document.querySelector("#maPl").value=e,document.querySelector("#fullPathFileName").value=s,document.querySelector("#tkhaiFormat").value=a,document.querySelector("#fileName").value=t,document.querySelector("#uploadButton").click()},i,format,u,p),await delay(4e3);var w=await e.evaluate(()=>!!document.querySelector(".app_error")&&document.querySelector(".app_error").textContent.replace("\n","").replace("\\n","").trim());if(fs.unlink("./upload/"+u,e=>{e?console.log("failed to delete local file:"+e):console.log("successfully deleted local file")}),w)s.status=!1,s.message=w,await e.close();else{try{const t=await e.evaluate(()=>{return Array.from(document.querySelectorAll("table tr td")).map(e=>e.innerText)});if(await e.close(),t.length>=1)return s.status=!0,s.message="Upload success",void a.send(s)}catch(t){return await e.close(),a.send(s),!1}a.send(s)}}else s.status=!1,s.message="Missing parameter or browser does not exists";a.send(s)}else a.send({status:!1,message:"Key error"})}),app.get("/close-browser/:browser_id",async(e,a)=>{var t=e.params.browser_id;if(e.query.key==key){var s={status:!0,message:"closed"};try{await closeBrowser(browsers[t]),delete browsers[t]}catch(e){s.error=e}a.send(s)}else a.send({status:!1,message:"Key error"})}),app.listen(3e3,()=>{console.log("App listening at port 3000")});